name: Playwright Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    paths:
      - ".github/workflows/playwright.yml"
      - "packages/**"
      - "package.json"
      - "pnpm-lock.yaml"
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  node-version: 22
  pnpm-version: 10

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: codecarrotlabs/github-actions/.github/actions/node-pnpm@c7e1e76
      with:
        node_version: ${{ env.node-version }}
        pnpm_version: ${{ env.pnpm-version }}

    - name: Run docker compose
      run: docker compose -f ./docker-compose.ci.yml up -d --build

    - name: Wait for frontend
      run: npx wait-on http://localhost:3000

    - name: Install Playwright Browsers
      run: pnpm exec playwright install --with-deps

    - name: Run Playwright tests
      run: pnpm exec playwright test

    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
