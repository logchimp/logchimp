<template>
  <auth-form>
    <div class="flex flex-col items-center mb-8">
      <site-branding
        :title="siteSettings.title"
        :logo="siteSettings.logo"
      />
    </div>

    <!-- Success -->
    <template v-if="success">
      <div class="card text-center flex flex-col items-center space-y-4">
        <success-icon class="w-8 h-8" color="#64B285" />

        <p>
          Thank you verifying your account.
        </p>
      </div>

      <AuthFormHelperText>
        You may close this window.
      </AuthFormHelperText>
    </template>

    <!-- Error -->
    <div v-if="error" class="card text-center flex flex-col items-center space-y-4">
      <error-icon class="w-8 h-8" color="#DE544E" />

      <div>
        Invalid or expired link. Please try again.
      </div>
    </div>

    <!-- Loading -->
    <loader-container v-if="loading" class="mt-16" />
  </auth-form>
</template>

<script setup lang="ts">
// packages
import { onMounted, ref } from "vue";
import { useHead } from "@vueuse/head";
import { CheckCircle as SuccessIcon, XCircle as ErrorIcon } from "lucide-vue";

// modules
import { router } from "../router";
import { useSettingStore } from "../store/settings";
import { verifyUserEmail } from "../modules/auth";

// components
import AuthForm from "../layout/AuthForm.vue";
import AuthFormHelperText from "../components/auth/AuthFormHelperText.vue";
import LoaderContainer from "../components/ui/LoaderContainer.vue";
import SiteBranding from "../components/site/SiteBranding.vue";

const { get: siteSettings } = useSettingStore();

const loading = ref(true);
const success = ref(false);
const error = ref(false);

async function verifyEmail() {
  const route = router.currentRoute.value;
  if (!route.query.token) {
    loading.value = false;
    error.value = true;
    return;
  }

  try {
    const token = route.query.token.toString();
    const response = await verifyUserEmail(token);

    if (response.data.verify.success) {
      success.value = true;
      loading.value = false;
    }
  } catch (error: any) {
    if (error.response.data.code === "USER_ALREADY_VERIFIED") {
      return router.push("/");
    }

    error.value = true;
    loading.value = false;
  }
}

onMounted(() => verifyEmail());

useHead({
  title: "Email verification",
  meta: [
    {
      name: "og:title",
      content: () => `Email verification Â· ${siteSettings.title}`,
    },
  ],
});

defineOptions({
  name: "EmailVerification",
});
</script>